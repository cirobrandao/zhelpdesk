#!/usr/bin/env php
<?php

declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';
require __DIR__ . '/../app/helpers.php';

use Dotenv\Dotenv;
use PDO;

$dotenv = Dotenv::createImmutable(base_path());
$dotenv->safeLoad();

$db = require base_path('config/database.php');
$dsn = sprintf('mysql:host=%s;port=%d;dbname=%s;charset=%s', $db['host'], $db['port'], $db['name'], $db['charset']);
$pdo = new PDO($dsn, $db['user'], $db['pass'], [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
]);

$pdo->exec('CREATE TABLE IF NOT EXISTS migrations (id INT AUTO_INCREMENT PRIMARY KEY, filename VARCHAR(255) NOT NULL UNIQUE, applied_at DATETIME NOT NULL)');

$migrationsDir = base_path('sql/migrations');
$files = array_values(array_filter(scandir($migrationsDir), fn ($f) => str_ends_with($f, '.sql')));
sort($files);

foreach ($files as $file) {
    $stmt = $pdo->prepare('SELECT id FROM migrations WHERE filename = :filename');
    $stmt->execute(['filename' => $file]);
    if ($stmt->fetch()) {
        continue;
    }

    $path = $migrationsDir . DIRECTORY_SEPARATOR . $file;
    $sql = file_get_contents($path) ?: '';

    if (preg_match('/^\s*SOURCE\s+(.+)$/mi', $sql, $matches)) {
        $sourcePath = trim($matches[1]);
        $sourceFile = realpath($migrationsDir . DIRECTORY_SEPARATOR . $sourcePath);
        if ($sourceFile && file_exists($sourceFile)) {
            $sql = file_get_contents($sourceFile) ?: '';
        }
    }

    $statements = array_filter(array_map('trim', explode(';', $sql)));
    foreach ($statements as $statement) {
        if ($statement === '') {
            continue;
        }
        $pdo->exec($statement);
    }

    $insert = $pdo->prepare('INSERT INTO migrations (filename, applied_at) VALUES (:filename, NOW())');
    $insert->execute(['filename' => $file]);
    echo "Applied: {$file}\n";
}

